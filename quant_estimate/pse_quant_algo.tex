\documentclass{article}

\usepackage{algorithm, algpseudocode}

\algnewcommand{\algorithmicforeach}{\textbf{for each}}
\algdef{SE}[FOR]{ForEach}{EndForEach}[1]
{\algorithmicforeach\ #1\ \algorithmicdo}% \ForEach{#1}
{\algorithmicend\ \algorithmicforeach}% \EndForEach
\usepackage{minted} 

\title{PSE Quant Sampling Algorithm}
\author{Sumit Lahiri}

\begin{document}
	\maketitle
	
We try to formulate a way to compute path probabilities using \texttt{symbolic execution} and \texttt{testing} based technique.  
\begin{minted}{c} 
int main(void)
{
	int a; // unintialized
	int d = std::uniform_distribution<rd_seed>(0, 650);
	
	// forall variable : (INT_MIN to INT_MAX)
	klee_make_symbolic(&a, sizeof(a), "a_sym");
	
	// PSE variable : Uniformly distributed [0 to 650]
	make_pse_symbolic<int>(&d, sizeof(d), "d_prob_sym", 0, 650);
	
	int c = a + 100;
	
	// case 1 : Pure Forall Predicate
	if (a > 50) {
	  c = a + 75;
	} else {
	  c = a - 75;
	}
	
	// case 2 : Pure PSE Predicate
	if (d > 60) d = 250;
	
	// case 3 : Dependence Case
	if (c > d) c = d;

	// Probabilistic query : assert(P(c != d) < 0.5)
	// Optimize here : 
	//	Optimal value of forall (a) such that P(c != d) is close to 0.5 	
	return 0;
}
\end{minted}

\begin{algorithm}[H]
    \caption{Dependence Case : (Testing Based Estimation)}
    \begin{algorithmic}[1]
        \ForEach{$p \in Paths$}%
        \State $c := ConstraintSet(p)$ \algorithmiccomment{Path Constraints for p}
        \State $m := Optimize(query,  c)$ \algorithmiccomment{solution for the path constraints}
        \State $concreteSet = \{ \}$
        	\ForEach{$v \in ForallVars(p)$} \algorithmiccomment{ForallVars p $\rightarrow $ forall} %
        	\State $concreteSet.append(\{key : v, val : m[v]\})$ \algorithmiccomment{Candidate Values}
        	\EndForEach
        \State $executeCV(program, concreteSet)$
        \EndForEach
    \end{algorithmic}
\end{algorithm}

\begin{algorithm}[H]
	\caption{executeCV : PSE Sampled Normal Execution}
	\begin{algorithmic}[1]
		\Function{executeCV}{$P : program, C : concreteSet$}
			\ForEach{$v \in ForallVars(p)$}%
			\State value(v) := concreteSet(v) \algorithmiccomment{Use values from ConcreteSet}
			\EndForEach
			\State ... \algorithmiccomment{proceed with normal execution}
		\EndFunction
	\end{algorithmic}
\end{algorithm}

For the sample program given above, we first resort to using \texttt{symbolic execution} to generate \texttt{path constraints} for all the feasible paths that this program can take and then convert the \texttt{path constraints} into an \texttt{formal logic} optimization problem that gives an \texttt{assignment} to \texttt{forall} variables such that it leads to optimum violation of the $query$.

\begin{minted}{python}
def generateCandidates(k: int):
	opt = z3.Optimize()
	a = z3.Int("a_sym")
	d = z3.Int("d_prob_sym")
	
	opt.add(d >= 0)
	opt.add(d <= 650)
	opt.add(a > 50)
	opt.add(z3.Not(d > 60))
	opt.add(a + 75 > d)

	opt.maximize(a - d - 75) 	# Query to optimize
	n = 0
	while opt.check() == z3.sat and n != k:
		m = opt.model()
		n += 1
		print("%s = %s" % (a, m[a]))
		print("%s = %s" % (d, m[d]))
		opt.add(a != m[a])
\end{minted}

\end{document}